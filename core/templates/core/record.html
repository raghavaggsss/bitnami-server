{% extends 'base.html' %}

{% load static %}

{% block content %}
    

   <div class="intro">Step2 : Here is your Karaoke! Be prepared for the recording!
   <br><br>
   <audio controls onloadeddata="var audioPlayer = this; setTimeout(function() { audioPlayer.play(); }, 5000)" onplay="myfunc()" onended="myfunc1()">
        <source src= /{{karaoke_url}} type="audio/wav" >
   </audio>
   </div>
   <script>
        function myfunc() {
            document.getElementById('recorder').click();
        }
        function myfunc1() {
            document.getElementById('stopper').click();
        }

        
    </script>
    
    <button id="recorder" class = "btn btn-primary" onclick="startRecording(this);">record</button>
  <button id="stopper" class = "btn btn-primary" onclick="stopRecording(this);" disabled>stop</button>
    
    <ul id="recordingslist"></ul>
    
    <div class = "btn btn-primary" onclick = "window.location.href = '{% url 'evaluate' %}';" id = "start">
        next page
      </div>

      <script>
  var audio_context;
  var recorder;

  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);

    
    
    recorder = new Recorder(input);
    
  }

  function startRecording(button) {
    recorder && recorder.record();
    button.disabled = true;
    button.nextElementSibling.disabled = false;
    
  }

  function stopRecording(button) {
    recorder && recorder.stop();
    button.disabled = true;
    button.previousElementSibling.disabled = false;
    
  


// function getCookie(name) {
//         var cookieValue = null;
//         if (document.cookie && document.cookie != '') {
//             var cookies = document.cookie.split(';');
//             for (var i = 0; i < cookies.length; i++) {
//                 var cookie = jQuery.trim(cookies[i]);
                
//                 if (cookie.substring(0, name.length + 1) == (name + '=')) {
//                     cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
//                     break;
//                 }
//             }
//         }
//         return cookieValue;}
        
//     function upload(blob){
//         var csrftoken = getCookie('csrftoken');
 
//         var xhr = new XMLHttpRequest();
//         xhr.open('POST', 'songtrain-3/SongTrain1/media/recordings', true);
//         xhr.setRequestHeader("X-CSRFToken", csrftoken);
//         xhr.setRequestHeader("MyCustomHeader", "abcd");
 
//         xhr.upload.onloadend = function() {
//             alert('Upload complete');
//         };
        
//         xhr.send(blob);    }

//     recorder && recorder.exportWAV(function(blob){
// var button = document.createElement('button');
//             var t = document.createTextNode("Upload?");
//             button.id = 'button';
//             button.appendChild(t);
//             button.onclick = function() {
//                 upload(blob.detail);  
//             };
      
//         });        

//     recorder && recorder.exportWAV(function(blob) {

//       var url = (window.URL || window.webkitURL).createObjectURL(blob);
//       console.log(url);

//       var data = new FormData();
//       data.append('file', blob);

//       $.ajax({
//         url :  "{% static 'core/js/record_render.php' %}",
//         type: 'POST',
//         data: data,
//         contentType: false,
//         processData: false,
        
        
//       });
// }); 
    createDownloadLink();
    recorder && recorder.clear();
  }  


  function createDownloadLink() {
    recorder && recorder.exportWAV(function(blob) {
      var url = URL.createObjectURL(blob);
      var li = document.createElement('li');
      var au = document.createElement('audio');
      var hf = document.createElement('a');
      
      au.controls = true;
      au.src = url;
      hf.href = url;
      hf.download = new Date().toISOString() + '.wav';
      hf.innerHTML = hf.download;
      li.appendChild(au);
      li.appendChild(hf);
      recordingslist.appendChild(li);
    });
  }

window.onload = function init() {
try {
// webkit shim
window.AudioContext = window.AudioContext || window.webkitAudioContext;
navigator.getUserMedia = ( navigator.getUserMedia ||
navigator.webkitGetUserMedia ||
navigator.mozGetUserMedia ||
navigator.msGetUserMedia);
window.URL = window.URL || window.webkitURL;
 
audio_context = new AudioContext;


} catch (e) {
alert('No web audio support in this browser!');
}
 
navigator.getUserMedia({audio: true}, startUserMedia, function(e) {

});
};
</script>
<script src="{% static 'core/js/recorder.js' %}"></script>
 
{% endblock %}
